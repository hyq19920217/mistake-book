import{p as ue,q as P,r as x,s as X,d as p,o as s,c as _,e as u,h as Q,w as t,f as $,t as V,k as B,b as r,F as I,m as U,u as de,l as ce,E as h,i as S,v as pe,x as _e,g as me,y as fe,n as ve}from"./index-BMI1Flys.js";import{u as ge}from"./notebook-DlYxDQa4.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Z=ue("question",{state:()=>({questions:[],currentQuestion:null,loading:!1,analyzing:!1}),actions:{async fetchQuestions(f){this.loading=!0;try{const n=await P.get(`/questions/notebook/${f}`);this.questions=n.data}catch(n){throw n}finally{this.loading=!1}},async createQuestion(f){const n=await P.post("/questions",f);return this.questions.unshift(n.data),n.data},async updateQuestion(f,n){const k=await P.patch(`/questions/${f}`,n),v=this.questions.findIndex(a=>a._id===f);return v!==-1&&(this.questions[v]=k.data),k.data},async deleteQuestion(f){await P.delete(`/questions/${f}`);const n=this.questions.findIndex(k=>k._id===f);n!==-1&&this.questions.splice(n,1)},async analyzeKnowledgePoints(f){this.analyzing=!0;try{const n=await P.post("/questions/analyze",{questionIds:f});return n.data.forEach(k=>{const v=this.questions.find(a=>a._id===k.questionId);v&&(v.knowledgePoints=k.knowledgePoints)}),n.data}catch(n){throw n}finally{this.analyzing=!1}},setCurrentQuestion(f){this.currentQuestion=f}}}),ye={class:"knowledge-map"},he={class:"map-header"},ke={class:"map-container"},be={class:"custom-tree-node"},we={key:0,class:"question-count"},qe={key:0,class:"questions-container"},$e={class:"question-content"},xe={class:"text-content"},Ve={key:0,class:"image-list"},Ce={key:1,class:"analysis"},Qe={class:"analysis-content"},Be={key:1,class:"empty-questions"},ze={__name:"KnowledgeMap",props:{questions:{type:Array,required:!0}},setup(f){const n=f;Z();const k=x(null),v=x(!1),a=x(null),j={children:"children",label:"label"},C=X(()=>{const d={};return n.questions.forEach(l=>{var w;(w=l.knowledgePoints)==null||w.forEach(i=>{const{level1:m,level2:g,level3:b}=i;d[m]||(d[m]={label:m,children:{},questions:[]}),d[m].questions.push(l),g&&(d[m].children[g]||(d[m].children[g]={label:g,children:{},questions:[]}),d[m].children[g].questions.push(l),b&&(d[m].children[g].children[b]||(d[m].children[g].children[b]={label:b,questions:[]}),d[m].children[g].children[b].questions.push(l)))})}),Object.entries(d).map(([l,w])=>({label:l,questions:w.questions,children:Object.entries(w.children).map(([i,m])=>({label:i,questions:m.questions,children:Object.entries(m.children).map(([g,b])=>({label:g,questions:b.questions}))}))}))}),M=d=>{var l;a.value=d,(l=d.questions)!=null&&l.length&&(v.value=!0)};return(d,l)=>{var T;const w=p("el-button"),i=p("el-tree"),m=p("el-image"),g=p("el-card"),b=p("el-drawer");return s(),_("div",ye,[u("div",he,[l[2]||(l[2]=u("h3",null,"知识点导航",-1)),a.value&&((T=a.value.questions)!=null&&T.length)?(s(),Q(w,{key:0,text:"",onClick:l[0]||(l[0]=q=>v.value=!v.value)},{default:t(()=>[$(V(v.value?"隐藏错题":"查看错题"),1)]),_:1})):B("",!0)]),u("div",ke,[r(i,{ref_key:"treeRef",ref:k,data:C.value,props:j,"highlight-current":"",onNodeClick:M},{default:t(({node:q,data:z})=>{var y;return[u("span",be,[u("span",null,V(q.label),1),(y=z.questions)!=null&&y.length?(s(),_("span",we," ("+V(z.questions.length)+") ",1)):B("",!0)])]}),_:1},8,["data"]),r(b,{modelValue:v.value,"onUpdate:modelValue":l[1]||(l[1]=q=>v.value=q),title:"相关错题",direction:"rtl",size:"50%"},{default:t(()=>{var q,z;return[(z=(q=a.value)==null?void 0:q.questions)!=null&&z.length?(s(),_("div",qe,[(s(!0),_(I,null,U(a.value.questions,y=>(s(),Q(g,{key:y._id,class:"question-card"},{default:t(()=>{var D;return[u("div",$e,[u("div",xe,V(y.content),1),(D=y.images)!=null&&D.length?(s(),_("div",Ve,[(s(!0),_(I,null,U(y.images,(K,A)=>(s(),Q(m,{key:A,src:K.url,"preview-src-list":y.images.map(O=>O.url),fit:"cover",class:"question-image"},null,8,["src","preview-src-list"]))),128))])):B("",!0),y.analysis?(s(),_("div",Ce,[l[3]||(l[3]=u("div",{class:"analysis-title"},"解析：",-1)),u("div",Qe,V(y.analysis),1)])):B("",!0)])]}),_:2},1024))),128))])):(s(),_("div",Be," 暂无相关错题 "))]}),_:1},8,["modelValue"])])])}}},Ne=Y(ze,[["__scopeId","data-v-27e4a5ff"]]),Ee={class:"notebook-container"},Se={class:"header"},Ie={class:"title"},Ue={class:"notebook-name"},Me={class:"actions"},Pe={class:"question-list"},Te={class:"question-content"},De={class:"text-content"},Re={key:0,class:"image-list"},je={key:1,class:"analysis"},Ke={class:"analysis-content"},Ae={key:2,class:"knowledge-points"},Oe={class:"question-footer"},Fe={key:0,class:"upload-list"},Le={class:"dialog-footer"},He={__name:"Notebook",setup(f){const n=pe(),k=me(),v=ge(),a=Z(),j=de(),C=x(!1),M=x(!1),d=x(!1),l=x(null),w=x("list"),i=x({content:"",images:[],analysis:"",notebookId:n.params.id}),m={content:[{required:!0,message:"请输入题目内容",trigger:"blur"}]},g=X(()=>({Authorization:`Bearer ${j.token}`}));ce(async()=>{try{await a.fetchQuestions(n.params.id)}catch{h.error("获取错题列表失败")}});const b=()=>{k.push("/")},T=()=>{d.value=!1,i.value={content:"",images:[],analysis:"",notebookId:n.params.id},C.value=!0},q=c=>{d.value=!0,i.value={...c,notebookId:n.params.id},C.value=!0},z=async c=>{try{await ve.confirm("确定要删除这道错题吗？此操作不可恢复。","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await a.deleteQuestion(c._id),h.success("删除成功")}catch(e){e!=="cancel"&&h.error("删除失败")}},y=c=>{const e=c.type.startsWith("image/"),F=c.size/1024/1024<5;return e?F?!0:(h.error("图片大小不能超过5MB"),!1):(h.error("只能上传图片文件"),!1)},D=c=>{i.value.images.push({url:c.data.url,description:""}),c.data.ocrText&&(i.value.content=i.value.content?`${i.value.content}
${c.data.ocrText}`:c.data.ocrText)},K=()=>{h.error("图片上传失败")},A=async()=>{if(l.value)try{await l.value.validate(),M.value=!0,d.value?(await a.updateQuestion(i.value._id,i.value),h.success("更新成功")):(await a.createQuestion(i.value),h.success("添加成功")),C.value=!1}catch(c){console.error(c),h.error(d.value?"更新失败":"添加失败")}finally{M.value=!1}},O=async()=>{if(!a.questions.length)return h.warning("暂无错题可分析");try{await a.analyzeKnowledgePoints(a.questions.map(c=>c._id)),h.success("知识点分析完成")}catch{h.error("知识点分析失败")}};return(c,e)=>{const F=p("el-page-header"),N=p("el-button"),ee=p("el-empty"),W=p("el-image"),te=p("el-tag"),se=p("el-card"),G=p("el-tab-pane"),oe=p("el-tabs"),J=p("el-input"),L=p("el-form-item"),ne=p("el-upload"),ae=p("el-form"),le=p("el-dialog"),ie=fe("loading");return s(),_("div",Ee,[u("div",Se,[u("div",Ie,[r(F,{onBack:b},{content:t(()=>{var o;return[u("span",Ue,V((o=S(v).currentNotebook)==null?void 0:o.name),1)]}),_:1})]),u("div",Me,[r(N,{type:"primary",onClick:T},{default:t(()=>e[5]||(e[5]=[$(" 添加错题 ")])),_:1}),r(N,{type:"success",loading:S(a).analyzing,onClick:O},{default:t(()=>e[6]||(e[6]=[$(" 分析知识点 ")])),_:1},8,["loading"])])]),r(oe,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=o=>w.value=o),class:"notebook-tabs"},{default:t(()=>[r(G,{label:"错题列表",name:"list"},{default:t(()=>[_e((s(),_("div",Pe,[S(a).questions.length?(s(!0),_(I,{key:1},U(S(a).questions,o=>(s(),Q(se,{key:o._id,class:"question-card"},{default:t(()=>{var R;return[u("div",Te,[u("div",De,V(o.content),1),o.images.length?(s(),_("div",Re,[(s(!0),_(I,null,U(o.images,(E,H)=>(s(),Q(W,{key:H,src:E.url,"preview-src-list":o.images.map(re=>re.url),fit:"cover",class:"question-image"},null,8,["src","preview-src-list"]))),128))])):B("",!0),o.analysis?(s(),_("div",je,[e[7]||(e[7]=u("div",{class:"analysis-title"},"解析：",-1)),u("div",Ke,V(o.analysis),1)])):B("",!0),(R=o.knowledgePoints)!=null&&R.length?(s(),_("div",Ae,[e[8]||(e[8]=u("div",{class:"knowledge-title"},"知识点：",-1)),(s(!0),_(I,null,U(o.knowledgePoints,(E,H)=>(s(),Q(te,{key:H,class:"knowledge-tag",type:"success"},{default:t(()=>[$(V(`${E.level1} > ${E.level2} > ${E.level3}`),1)]),_:2},1024))),128))])):B("",!0)]),u("div",Oe,[r(N,{text:"",onClick:E=>q(o)},{default:t(()=>e[9]||(e[9]=[$("编辑")])),_:2},1032,["onClick"]),r(N,{text:"",type:"danger",onClick:E=>z(o)},{default:t(()=>e[10]||(e[10]=[$("删除")])),_:2},1032,["onClick"])])]}),_:2},1024))),128)):(s(),Q(ee,{key:0,description:"暂无错题"}))])),[[ie,S(a).loading]])]),_:1}),r(G,{label:"知识点导航",name:"map"},{default:t(()=>[r(Ne,{questions:S(a).questions},null,8,["questions"])]),_:1})]),_:1},8,["modelValue"]),r(le,{modelValue:C.value,"onUpdate:modelValue":e[4]||(e[4]=o=>C.value=o),title:d.value?"编辑错题":"添加错题",width:"60%"},{footer:t(()=>[u("span",Le,[r(N,{onClick:e[3]||(e[3]=o=>C.value=!1)},{default:t(()=>e[14]||(e[14]=[$("取消")])),_:1}),r(N,{type:"primary",onClick:A,loading:M.value},{default:t(()=>e[15]||(e[15]=[$(" 确定 ")])),_:1},8,["loading"])])]),default:t(()=>[r(ae,{ref_key:"formRef",ref:l,model:i.value,rules:m,"label-width":"80px"},{default:t(()=>[r(L,{label:"题目",prop:"content"},{default:t(()=>[r(J,{modelValue:i.value.content,"onUpdate:modelValue":e[1]||(e[1]=o=>i.value.content=o),type:"textarea",rows:4,placeholder:"请输入题目内容"},null,8,["modelValue"])]),_:1}),r(L,{label:"图片"},{default:t(()=>[r(ne,{class:"image-upload",action:"/api/upload/image",headers:g.value,"on-success":D,"on-error":K,"before-upload":y,accept:"image/*",multiple:""},{tip:t(()=>e[12]||(e[12]=[u("div",{class:"el-upload__tip"}," 支持jpg/png格式，单个文件不超过5MB ",-1)])),default:t(()=>[r(N,{type:"primary"},{default:t(()=>e[11]||(e[11]=[$("上传图片")])),_:1})]),_:1},8,["headers"]),i.value.images.length?(s(),_("div",Fe,[(s(!0),_(I,null,U(i.value.images,(o,R)=>(s(),Q(W,{key:R,src:o.url,fit:"cover",class:"upload-image"},{placeholder:t(()=>e[13]||(e[13]=[u("div",{class:"image-slot"},"加载中",-1)])),_:2},1032,["src"]))),128))])):B("",!0)]),_:1}),r(L,{label:"解析",prop:"analysis"},{default:t(()=>[r(J,{modelValue:i.value.analysis,"onUpdate:modelValue":e[2]||(e[2]=o=>i.value.analysis=o),type:"textarea",rows:3,placeholder:"请输入题目解析"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Xe=Y(He,[["__scopeId","data-v-9c273f32"]]);export{Xe as default};
